#!/bin/bash

SCRIPT_PATH=$(readlink -f "${BASH_SOURCE[0]}")
SCRIPT_DIR=$(dirname "$SCRIPT_PATH")

PWNBOX_HELPER="${SCRIPT_DIR}/pwnbox-helper.sh"

source "$PWNBOX_HELPER" || exit

function print_service_status() {
    systemctl status $1 >/dev/null
    if [ $? == 0 ];
    then
        # echo -e "  ${1}\t\t ${COLOR_GREEN_BOLD}RUNNING${COLOR_RST}"
        printf "| %-26s | ${COLOR_GREEN_BOLD}%-7s${COLOR_RST} |\n" ${1} "RUNNING"
    else
        # echo -e "  ${1} is ${COLOR_RED_BOLD}STOPPED${COLOR_RST}"
        printf "| %-26s | ${COLOR_RED_BOLD}%-7s${COLOR_RST} |\n" ${1} "STOPPED"
    fi
}

function print_listening_ports_4() {
    for lp in $(ss -lpnt4H | awk '{ print $4 }' | sort);
    do
        a=$(echo $lp | cut -d: -f1)
        p=$(echo $lp | cut -d: -f2)
        printf "| %26s | ${COLOR_CYAN_BOLD}%-7s${COLOR_RST} |\n" $a $p
    done
}

function print_listening_ports_6() {
    for lp in $(ss -lpnt6H | awk '{ print $4 }' | sort);
    do
        a="$(echo $lp | cut -d']' -f1)]"
        p=$(echo $lp | rev | cut -d: -f1 | rev)
        # echo "$a $p"
        printf "| %26s | ${COLOR_CYAN_BOLD}%-7s${COLOR_RST} |\n" $a $p
    done
}

echo "+--------------------------------------+"
printf "| ${COLOR_CYAN_BOLD}%-36s${COLOR_RST} |\n" "Services"
echo "+----------------------------+---------+"
print_service_status "open-vm-tools"
print_service_status "snapd"
print_service_status "NetworkManager"
print_service_status "nessusd"
print_service_status "smbd"

echo "+----------------------------+---------+"
printf "| ${COLOR_CYAN_BOLD}%-36s${COLOR_RST} |\n" "Listening ports (IPv4)"
echo "+----------------------------+---------+"
print_listening_ports_4

echo "+----------------------------+---------+"
printf "| ${COLOR_CYAN_BOLD}%-36s${COLOR_RST} |\n" "Listening ports (IPv6)"
echo "+----------------------------+---------+"
print_listening_ports_6

echo "+----------------------------+---------+"