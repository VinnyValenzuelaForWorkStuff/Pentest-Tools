#!/usr/bin/env python3

import os
import argparse
from log import *
from helper import *
from controller import *

def main():

    parser = argparse.ArgumentParser(
                    prog = 'Pwnbox manager',
                    description = 'Install or update a Kali Linux attack machine')
    parser.add_argument('action', choices=[ 'install', 'update' ])
    args = parser.parse_args()

    if not Check.is_root():
        Logger.error("Not running as root.")
        return 1

    Logger.success("Running as root.")

    if not Check.is_run_with_preserved_env():
        Logger.error("Not running with preserved environment.")
        return 2
    
    Logger.success("Environment OK.")

    if not Check.is_connected_to_internet():
        Logger.error("Not connected to the Internet.")
        return 3
    
    Logger.success("Internet connection OK.")

    config_filepath = "{}/config.json".format(os.path.dirname(os.path.realpath(__file__)))
    controller = Controller(config_file=config_filepath)

    if controller.config.config is None:
        return 4

    if args.action == 'update':
        controller.update_all()
    elif args.action == 'install':
        controller.install_all()
    
    return 0

if __name__ == '__main__':
    main()
