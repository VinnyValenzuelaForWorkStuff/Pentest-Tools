#!/bin/bash

SCRIPT_PATH=$(readlink -f "${BASH_SOURCE[0]}")
SCRIPT_DIR=$(dirname "$SCRIPT_PATH")
AD_HELPER="${SCRIPT_DIR}/ad-helper.sh"

source "$AD_HELPER" || exit

function print_usage {
    print_info "Usage:"
    print_info "  ${0} <add|del> fqdn [ip]"
    print_info "Examples:"
    print_info "  Add a record: ${0} foo123.example.com 10.10.10.123"
    print_info "  Delete a record: ${0} foo123.example.com"
}

function record_add {
    if [ $# -eq 2 ]
    then
        ns=$(get_dns_servers || return)
        arg_server=$(echo "${ns}" | head -n1)
        arg_fqdn=$1
        arg_ip=$2
        res=$(echo -e "server ${arg_server}\nupdate add ${arg_fqdn} 86400 A ${arg_ip}\nsend\nquit\n" | nsupdate 2>&1)
        if [ $? -eq 0 ]
        then
            print_success "Added record '${arg_fqdn} -> ${arg_ip}' on DNS server ${arg_server}"
        else
            print_error "Failed to add record: '${res}'"
        fi
    else
        print_error "Invalid number of arguments"
        print_usage
    fi
}

function record_del {
    if [ $# -eq 1 ]
    then
        ns=$(get_dns_servers || return)
        arg_server=$(echo "${ns}" | head -n1)
        arg_fqdn=$1
        res=$(echo -e "server ${arg_server}\nupdate delete ${arg_fqdn} A\nsend\nquit\n" | nsupdate 2>&1)
        if [ $? -eq 0 ]
        then
            print_success "Deleted record '${arg_fqdn}' on DNS server ${arg_server}"
        else
            print_error "Failed to delete record: '${res}'"
        fi
    else
        print_error "Invalid number of arguments"
        print_usage
    fi
}

if [ $# == 0 ]
then
    print_usage
    exit
fi

case $1 in
"add")
    record_add ${@:2}
    ;;
"del")
    record_del ${@:2}
    ;;
*)
    print_error "Unknown command: ${1}"
    ;;
esac